# 08 EvoMind 全量技术蓝图（安卓端 + 服务端）

## 1. 目标与范围

本蓝图用于指导 EvoMind 从 0 到 1 进入可上线状态，覆盖：

- 安卓端完整分层架构、页面与业务域模块
- 服务端微服务拆分、网关、安全、审核、计费、支付
- 多模型路由、限流降级、成本观测
- 本地优先与云端协同的数据一致性策略
- 上架前全量测试与发布治理

## 2. 安卓端完整架构（Kotlin + Jetpack）

### 2.1 分层

1. `app`：启动、路由、全局依赖注入、统一异常处理
2. `core-ui`：主题、组件、动效、无障碍
3. `core-network`：API 客户端、拦截器、签名、重试
4. `core-db`：Room + SQLCipher + Migration
5. `core-ai`：模型调用网关、提示词模板、审核标记
6. `core-permission`：相册/麦克风/通知/存储动态授权
7. `feature-*`：按业务域拆分（登录、引导、信息源、认知、内化、行动、小组、我的）

### 2.2 页面路由图（主流程）

- 启动页 → 登录注册页 → 新手引导（5步） → 首页
- 首页 → 认知卡片详情 → 脑图下钻 → 原文段落临时查看
- 首页 → 每日一问 → 文字/语音回答 → 讨论总结入库
- 信息源页 → 截图识别导入 / 手动链接导入 / 分组管理
- 我的页 → 订阅套餐 → 下单 → 微信/支付宝支付 → 权益生效

### 2.3 关键状态机

#### A. 登录状态机

- 未登录
- 验证码发送中
- 验证通过
- 登录成功（本地会话 + 服务端会话）
- 登录失效（触发静默刷新）

#### B. 信息源导入状态机

- 待上传截图
- OCR识别中
- 候选列表确认
- 导入成功
- 识别失败（可转手动输入）

#### C. 支付状态机

- 创建订单
- 拉起支付
- 待回调
- 支付成功（权益到账）
- 支付失败（可重试）
- 超时关闭

### 2.4 本地优先同步策略

- 写入优先本地：所有学习行为先写本地数据库
- 增量上报云端：网络可用时批量同步非隐私必要字段
- 冲突处理：最后修改时间 + 版本号（乐观锁）
- 失败补偿：WorkManager 指数退避 + 死信队列本地缓存

### 2.5 可观测性

- 客户端埋点：页面停留、转化漏斗、崩溃、ANR
- 关键指标：启动时长、卡片打开耗时、OCR成功率、支付成功率
- 质量阈值：崩溃率 < 0.3%，ANR < 0.2%

## 3. 服务端完整架构

### 3.1 服务拆分

- 网关服务：鉴权、限流、签名验签、灰度路由
- 用户服务：账号体系、设备管理、注销与导出
- 信息源服务：OCR结果处理、链接校验、去重、分组
- 认知服务：卡片生成、脑图生成、冲突标记
- 讨论服务：每日一问、追问链、总结归档
- 行动服务：挑战任务、作品归档、能力解锁
- 订阅服务：套餐、权益、算力账本、续费提醒
- 支付服务：微信/支付宝下单、回调验签、退款工单
- 审核服务：输入输出内容合规检测、审计留痕

### 3.2 事件总线主题

- `user.registered`
- `onboarding.completed`
- `source.imported`
- `card.generated`
- `discussion.finalized`
- `task.completed`
- `payment.succeeded`
- `subscription.expiring`

### 3.3 安全与合规

- API 鉴权：JWT + 设备指纹 + 风险评分
- 数据脱敏：手机号、openid、日志脱敏
- 审核链路：请求前审核、生成后审核、分享前审核
- 数据权利：导出、删除、注销均提供工单与回执

## 4. 计费与套餐引擎

### 4.1 指标

- 信息源数量
- 冲突标记调用次数
- 摘要 token 消耗
- 讨论轮数
- Agent 训练次数

### 4.2 公式

- 实时成本 = Σ(指标用量 × 单价)
- 展示成本 = 向上取整(实时成本)
- 订阅费 = 展示成本 × 2

### 4.3 保障

- 每 10 分钟刷新快照
- 价格变更前站内提醒
- 订单页显示成本构成（算力/运营）

## 5. 发布架构

- 环境：开发、测试、预发、生产
- 发布：蓝绿发布 + 灰度发布
- 回滚：一分钟内切回上一个稳定版本
- 备份：数据库每日全量 + 每小时增量
